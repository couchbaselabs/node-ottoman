<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Schema | Ottoman.js</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Ottoman is an ODM built for Couchbase and Node.js. ">
    
    <link rel="preload" href="/assets/css/0.styles.caccd980.css" as="style"><link rel="preload" href="/assets/js/app.2456a84d.js" as="script"><link rel="preload" href="/assets/js/2.bbab3e56.js" as="script"><link rel="preload" href="/assets/js/10.a2b444de.js" as="script"><link rel="prefetch" href="/assets/js/100.608d621e.js"><link rel="prefetch" href="/assets/js/101.7b29bda4.js"><link rel="prefetch" href="/assets/js/102.86a6798d.js"><link rel="prefetch" href="/assets/js/11.d232bdf4.js"><link rel="prefetch" href="/assets/js/12.d3c4e441.js"><link rel="prefetch" href="/assets/js/13.a863239f.js"><link rel="prefetch" href="/assets/js/14.d411b53e.js"><link rel="prefetch" href="/assets/js/15.ebbe8a18.js"><link rel="prefetch" href="/assets/js/16.9de17c93.js"><link rel="prefetch" href="/assets/js/17.0bb1a951.js"><link rel="prefetch" href="/assets/js/18.78ba45a0.js"><link rel="prefetch" href="/assets/js/19.4d99cb89.js"><link rel="prefetch" href="/assets/js/20.9ab2a1d9.js"><link rel="prefetch" href="/assets/js/21.1bf343f9.js"><link rel="prefetch" href="/assets/js/22.cb9539b9.js"><link rel="prefetch" href="/assets/js/23.0536f305.js"><link rel="prefetch" href="/assets/js/24.b96e608f.js"><link rel="prefetch" href="/assets/js/25.ad82996e.js"><link rel="prefetch" href="/assets/js/26.3a58c194.js"><link rel="prefetch" href="/assets/js/27.948f3b73.js"><link rel="prefetch" href="/assets/js/28.945cae35.js"><link rel="prefetch" href="/assets/js/29.b16927e5.js"><link rel="prefetch" href="/assets/js/3.a8089fdd.js"><link rel="prefetch" href="/assets/js/30.3252c565.js"><link rel="prefetch" href="/assets/js/31.a08a49a4.js"><link rel="prefetch" href="/assets/js/32.ecbb8c68.js"><link rel="prefetch" href="/assets/js/33.78800a7e.js"><link rel="prefetch" href="/assets/js/34.3e09a062.js"><link rel="prefetch" href="/assets/js/35.828207df.js"><link rel="prefetch" href="/assets/js/36.c420886d.js"><link rel="prefetch" href="/assets/js/37.726e66fb.js"><link rel="prefetch" href="/assets/js/38.88b7b660.js"><link rel="prefetch" href="/assets/js/39.e76bcd9f.js"><link rel="prefetch" href="/assets/js/4.5f3abae6.js"><link rel="prefetch" href="/assets/js/40.ba4c33a9.js"><link rel="prefetch" href="/assets/js/41.a78c9ae7.js"><link rel="prefetch" href="/assets/js/42.9e9467ca.js"><link rel="prefetch" href="/assets/js/43.57946ee1.js"><link rel="prefetch" href="/assets/js/44.b44150fe.js"><link rel="prefetch" href="/assets/js/45.80476705.js"><link rel="prefetch" href="/assets/js/46.4d31276b.js"><link rel="prefetch" href="/assets/js/47.7c6dcb87.js"><link rel="prefetch" href="/assets/js/48.96096a85.js"><link rel="prefetch" href="/assets/js/49.661b8a74.js"><link rel="prefetch" href="/assets/js/5.358d6336.js"><link rel="prefetch" href="/assets/js/50.c4314871.js"><link rel="prefetch" href="/assets/js/51.2d25bd0a.js"><link rel="prefetch" href="/assets/js/52.6432a531.js"><link rel="prefetch" href="/assets/js/53.eefec48a.js"><link rel="prefetch" href="/assets/js/54.e7c70236.js"><link rel="prefetch" href="/assets/js/55.3fada008.js"><link rel="prefetch" href="/assets/js/56.17bdab46.js"><link rel="prefetch" href="/assets/js/57.1bbbb968.js"><link rel="prefetch" href="/assets/js/58.4990390e.js"><link rel="prefetch" href="/assets/js/59.36bb2fbb.js"><link rel="prefetch" href="/assets/js/6.5dfce61f.js"><link rel="prefetch" href="/assets/js/60.cb733a9f.js"><link rel="prefetch" href="/assets/js/61.f2e86e6c.js"><link rel="prefetch" href="/assets/js/62.cc9050d6.js"><link rel="prefetch" href="/assets/js/63.4bae34c6.js"><link rel="prefetch" href="/assets/js/64.03791dc2.js"><link rel="prefetch" href="/assets/js/65.bce44d80.js"><link rel="prefetch" href="/assets/js/66.6714f4f4.js"><link rel="prefetch" href="/assets/js/67.61bee287.js"><link rel="prefetch" href="/assets/js/68.4e7f929a.js"><link rel="prefetch" href="/assets/js/69.4f41fd6d.js"><link rel="prefetch" href="/assets/js/7.b8874ac9.js"><link rel="prefetch" href="/assets/js/70.cfd1df02.js"><link rel="prefetch" href="/assets/js/71.cf1b4450.js"><link rel="prefetch" href="/assets/js/72.e9bdec07.js"><link rel="prefetch" href="/assets/js/73.d4730a88.js"><link rel="prefetch" href="/assets/js/74.980b45d0.js"><link rel="prefetch" href="/assets/js/75.fdd02a30.js"><link rel="prefetch" href="/assets/js/76.2ff30101.js"><link rel="prefetch" href="/assets/js/77.c9d9184d.js"><link rel="prefetch" href="/assets/js/78.16d22861.js"><link rel="prefetch" href="/assets/js/79.e935681c.js"><link rel="prefetch" href="/assets/js/8.e17cf35d.js"><link rel="prefetch" href="/assets/js/80.e6ac9c5e.js"><link rel="prefetch" href="/assets/js/81.ccee3bab.js"><link rel="prefetch" href="/assets/js/82.244a93e4.js"><link rel="prefetch" href="/assets/js/83.f2eb0265.js"><link rel="prefetch" href="/assets/js/84.bb6bff7a.js"><link rel="prefetch" href="/assets/js/85.38dad887.js"><link rel="prefetch" href="/assets/js/86.5c476b4e.js"><link rel="prefetch" href="/assets/js/87.0be7b16d.js"><link rel="prefetch" href="/assets/js/88.ffd2c566.js"><link rel="prefetch" href="/assets/js/89.ab2ad4f4.js"><link rel="prefetch" href="/assets/js/9.e0f1c88a.js"><link rel="prefetch" href="/assets/js/90.b774681d.js"><link rel="prefetch" href="/assets/js/91.a466bd7e.js"><link rel="prefetch" href="/assets/js/92.590c950e.js"><link rel="prefetch" href="/assets/js/93.2200261c.js"><link rel="prefetch" href="/assets/js/94.d600deaa.js"><link rel="prefetch" href="/assets/js/95.aad38097.js"><link rel="prefetch" href="/assets/js/96.4daf336c.js"><link rel="prefetch" href="/assets/js/97.7881802f.js"><link rel="prefetch" href="/assets/js/98.7d40fa2e.js"><link rel="prefetch" href="/assets/js/99.913c8da8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.caccd980.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ottoman.js</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guides/faq.html" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/guides/quick-start.html" class="nav-link">
  Quick Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Basic" class="dropdown-title"><span class="title">Basic</span> <span class="arrow down"></span></button> <button type="button" aria-label="Basic" class="mobile-dropdown-title"><span class="title">Basic</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guides/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/guides/schema.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Schema
</a></li><li class="dropdown-item"><!----> <a href="/guides/model.html" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/guides/document.html" class="nav-link">
  Document
</a></li><li class="dropdown-item"><!----> <a href="/guides/query-builder.html" class="nav-link">
  Query Builder
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Advanced" class="dropdown-title"><span class="title">Advanced</span> <span class="arrow down"></span></button> <button type="button" aria-label="Advanced" class="mobile-dropdown-title"><span class="title">Advanced</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advanced/how-ottoman-works.html" class="nav-link">
  How Ottoman Works
</a></li><li class="dropdown-item"><!----> <a href="/advanced/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/guides/mongoose-to-couchbase.html" class="nav-link">
  Mongoose to Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/guides/ottoman-couchbase.html" class="nav-link">
  Ottoman for Couchbase Node.js SDK devs
</a></li><li class="dropdown-item"><!----> <a href="/guides/ottomanV1-to-ottomanV2.html" class="nav-link">
  Ottoman V1 to Ottoman V2
</a></li></ul></div></div><div class="nav-item"><a href="/guides/first-app.html" class="nav-link">
  Example
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API" class="dropdown-title"><span class="title">API</span> <span class="arrow down"></span></button> <button type="button" aria-label="API" class="mobile-dropdown-title"><span class="title">API</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/classes/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/classes/schema.html" class="nav-link">
  Schema
</a></li><li class="dropdown-item"><!----> <a href="/classes/model.html" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/classes/document.html" class="nav-link">
  Document
</a></li><li class="dropdown-item"><!----> <a href="/classes/query.html" class="nav-link">
  Query Builder
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/couchbaselabs/node-ottoman" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guides/faq.html" class="nav-link">
  FAQ
</a></div><div class="nav-item"><a href="/guides/quick-start.html" class="nav-link">
  Quick Start
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Basic" class="dropdown-title"><span class="title">Basic</span> <span class="arrow down"></span></button> <button type="button" aria-label="Basic" class="mobile-dropdown-title"><span class="title">Basic</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guides/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/guides/schema.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Schema
</a></li><li class="dropdown-item"><!----> <a href="/guides/model.html" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/guides/document.html" class="nav-link">
  Document
</a></li><li class="dropdown-item"><!----> <a href="/guides/query-builder.html" class="nav-link">
  Query Builder
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Advanced" class="dropdown-title"><span class="title">Advanced</span> <span class="arrow down"></span></button> <button type="button" aria-label="Advanced" class="mobile-dropdown-title"><span class="title">Advanced</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/advanced/how-ottoman-works.html" class="nav-link">
  How Ottoman Works
</a></li><li class="dropdown-item"><!----> <a href="/advanced/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/guides/mongoose-to-couchbase.html" class="nav-link">
  Mongoose to Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/guides/ottoman-couchbase.html" class="nav-link">
  Ottoman for Couchbase Node.js SDK devs
</a></li><li class="dropdown-item"><!----> <a href="/guides/ottomanV1-to-ottomanV2.html" class="nav-link">
  Ottoman V1 to Ottoman V2
</a></li></ul></div></div><div class="nav-item"><a href="/guides/first-app.html" class="nav-link">
  Example
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API" class="dropdown-title"><span class="title">API</span> <span class="arrow down"></span></button> <button type="button" aria-label="API" class="mobile-dropdown-title"><span class="title">API</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/classes/ottoman.html" class="nav-link">
  Ottoman
</a></li><li class="dropdown-item"><!----> <a href="/classes/schema.html" class="nav-link">
  Schema
</a></li><li class="dropdown-item"><!----> <a href="/classes/model.html" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/classes/document.html" class="nav-link">
  Document
</a></li><li class="dropdown-item"><!----> <a href="/classes/query.html" class="nav-link">
  Query Builder
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/couchbaselabs/node-ottoman" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Schema</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guides/schema.html#defining-your-schema" class="sidebar-link">Defining Your Schema</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#allowed-schematypes" class="sidebar-link">Allowed SchemaTypes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#custom-schematypes" class="sidebar-link">Custom SchemaTypes</a></li></ul></li><li><a href="/guides/schema.html#schema-options" class="sidebar-link">Schema Options</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#option-timestamps" class="sidebar-link">Option Timestamps</a></li></ul></li><li><a href="/guides/schema.html#creating-a-model" class="sidebar-link">Creating a Model</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#instance-methods" class="sidebar-link">Instance Methods</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#statics" class="sidebar-link">Statics</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#indexes" class="sidebar-link">Indexes</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#index-types" class="sidebar-link">Index Types</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#n1ql-query-language" class="sidebar-link">N1QL Query Language</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#refdoc" class="sidebar-link">RefDoc</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#view" class="sidebar-link">View</a></li></ul></li><li><a href="/guides/schema.html#hooks" class="sidebar-link">Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#available-hooks" class="sidebar-link">Available Hooks</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#register-hooks-with-pre" class="sidebar-link">Register Hooks with pre</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#hooks-use-cases" class="sidebar-link">Hooks Use Cases</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#errors-in-pre-hooks" class="sidebar-link">Errors in Pre Hooks</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#post-hooks" class="sidebar-link">Post Hooks</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#define-hooks-before-compiling-models" class="sidebar-link">Define Hooks Before Compiling Models</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#save-validate-hooks" class="sidebar-link">Save/Validate Hooks</a></li></ul></li><li><a href="/guides/schema.html#plugins" class="sidebar-link">Plugins</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#plugin-example" class="sidebar-link">Plugin Example</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#global-plugins" class="sidebar-link">Global Plugins</a></li></ul></li><li><a href="/guides/schema.html#strict-mode" class="sidebar-link">Strict Mode</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/guides/schema.html#schema-types-immutable-option" class="sidebar-link">Schema Types Immutable Option</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#immutable-with-strategy-true-default" class="sidebar-link">Immutable with strategy true (default)</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#immutable-with-strategy-false" class="sidebar-link">Immutable with strategy false</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#immutable-with-strategy-throw" class="sidebar-link">Immutable with strategy THROW</a></li></ul></li><li><a href="/guides/schema.html#schema-helpful-methods" class="sidebar-link">Schema Helpful Methods</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#cast-method" class="sidebar-link">Cast Method</a></li><li class="sidebar-sub-header"><a href="/guides/schema.html#validate-method" class="sidebar-link">Validate method</a></li></ul></li><li><a href="/guides/schema.html#extend-schemas" class="sidebar-link">Extend Schemas</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guides/schema.html#add-method" class="sidebar-link">Add Method</a></li></ul></li><li><a href="/guides/schema.html#next-up" class="sidebar-link">Next Up</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="schema"><a href="#schema" class="header-anchor">#</a> Schema</h1> <p>Schema maps to a Couchbase collection and defines the shape of the documents within that collection.</p> <p><img src="/assets/img/howToUse.c6f255a6.jpg" alt="How to Use"></p> <h2 id="defining-your-schema"><a href="#defining-your-schema" class="header-anchor">#</a> Defining Your Schema</h2> <p>Everything in Ottoman starts with a Schema.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> blogSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  author<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token comment">// String is shorthand for { type: String }</span>
  authorNative<span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>String<span class="token punctuation">,</span>
  body<span class="token operator">:</span> String<span class="token punctuation">,</span>
  comments<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> body<span class="token operator">:</span> String<span class="token punctuation">,</span> date<span class="token operator">:</span> Date <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Date<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span>now <span class="token punctuation">}</span><span class="token punctuation">,</span>
  hidden<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  status<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Close'</span><span class="token punctuation">,</span> <span class="token string">'Open'</span><span class="token punctuation">,</span> <span class="token string">'Review'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span>
    votes<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Number<span class="token punctuation">,</span> min<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    favs<span class="token operator">:</span> Number<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mixedObject<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  mixedNative<span class="token operator">:</span> Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>Mixed<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>For more information about options, please <a href="/guides/schema.html#allowed-schematypes">review the types</a></p> <p>Each key in our code <code>blogSchema</code> defines a property in our documents which will be cast to its associated <a href="#allowed-schematypes">SchemaType</a>. For example, we've defined a property <code>title</code> that will be cast to the <a href="/classes/stringtype.html">String</a> SchemaType and property <code>date</code> which will be cast to a <a href="/classes/datetype.html">Date</a> SchemaType.</p> <p>Please note above that if a property only requires a type, it can be specified using a shorthand notation (contrast the <code>title</code> property above with the <code>date</code> property).</p> <p>Keys may also be assigned to nested objects containing further key/type definitions like the <code>meta</code> property above.
This will happen whenever a key's value is a POJO that lacks a bona fide <code>type</code> property.
In these cases, only the leaves in a tree are given actual paths in the schema (like <code>meta.votes</code> and <code>meta.favs</code> above), and the branches do not have actual paths.
The <code>meta</code> above cannot have its own validation as a side-effect of this. If validation is needed up the tree, a path needs to be created up the tree.</p> <h2 id="allowed-schematypes"><a href="#allowed-schematypes" class="header-anchor">#</a> Allowed SchemaTypes</h2> <ul><li><a href="/classes/stringtype">String</a></li> <li><a href="/classes/numbertype">Number</a></li> <li><a href="/classes/booleantype">Boolean</a></li> <li><a href="/classes/datetype">Date</a></li> <li><a href="/classes/arraytype">Array</a></li> <li><a href="/classes/embedtype">Embed</a></li> <li><a href="/classes/referencetype">Reference</a></li> <li><a href="/classes/mixedtype">Mixed</a></li> <li><em><a href="/guides/schema.html#custom-schematypes">Custom</a></em></li></ul> <p>Schemas not only define the structure of your document and casting of properties, they also define document <a href="#instance-methods">instance methods</a>, <a href="#statics">static Model methods</a>,
<a href="#indexes">compound indexes</a>, <a href="#plugins">plugins</a>, and document lifecycle <a href="#hooks">hooks</a>.</p> <h3 id="custom-schematypes"><a href="#custom-schematypes" class="header-anchor">#</a> Custom SchemaTypes</h3> <p>Ottoman supports custom types. Before you reach for a custom type, however, know that a custom type is overkill for most use cases.</p> <p>Let's take a look at an example of a basic schema type: a 1-byte integer. To create a new schema type, you need to inherit from <code>IOttomanType</code> and add the corresponding <code>registerType</code>. The only methods you need to implement are <a href="/guides/schema.html#cast-method">cast()</a> and <a href="/guides/schema.html#validate-method">validate()</a>.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">Int8</span> <span class="token keyword">extends</span> <span class="token class-name">IOttomanType</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'Int8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">cast</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> castedValue <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>castedValue<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token function">checkCastStrategy</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token constant">CAST_STRATEGY</span><span class="token punctuation">.</span><span class="token constant">THROW</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> castedValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">validate</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> int8Value <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>int8Value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ValidationError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Int8: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a number</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    int8Value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>int8Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>int8Value <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">0x80</span> <span class="token operator">||</span> int8Value <span class="token operator">&gt;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ValidationError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Int8: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is outside of the range of valid 8-bit ints</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> int8Value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Don't forget to add `Int8` to the type registry</span>
<span class="token function">registerType</span><span class="token punctuation">(</span>Int8<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Int8</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Define schema and model</span>
<span class="token keyword">const</span> CustomTypeSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> test<span class="token operator">:</span> Int8 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> CustomTypeModel <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'CustomTypeExample'</span><span class="token punctuation">,</span> CustomTypeSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

CustomTypeSchema <span class="token keyword">instanceof</span> <span class="token class-name">Schema</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
CustomTypeSchema<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">Int8</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomTypeModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token number">0x6f</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
value<span class="token punctuation">.</span><span class="token function">_validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>test<span class="token punctuation">;</span> <span class="token comment">// 111</span>

<span class="token keyword">const</span> bigger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomTypeModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token number">0x8f</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bigger<span class="token punctuation">.</span><span class="token function">_validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ValidationError: Int8: 143 is outside of the range of valid 8-bit ints</span>

<span class="token keyword">const</span> invalid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomTypeModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token string">'invalid test value'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
invalid<span class="token punctuation">.</span><span class="token function">_validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ValidationError: Property 'test' must be of type 'Int8'</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="schema-options"><a href="#schema-options" class="header-anchor">#</a> Schema Options</h2> <p>Schemas have a few configurable options which can be passed to the constructor:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The availables options are:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SchemaOptions</span> <span class="token punctuation">{</span>
  strict<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  preHooks<span class="token operator">?</span><span class="token operator">:</span> Hook<span class="token punctuation">;</span>
  postHooks<span class="token operator">?</span><span class="token operator">:</span> Hook<span class="token punctuation">;</span>
  timestamps<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> SchemaTimestampsConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="option-timestamps"><a href="#option-timestamps" class="header-anchor">#</a> Option Timestamps</h3> <p>The timestamps option tells <code>Ottoman</code> to assign <code>createdAt</code> and <code>updatedAt</code> fields to your schema. The type assigned is <code>Date</code>.</p> <p>By default, the names of the fields are <code>createdAt</code> and <code>updatedAt</code>. Customize the field names by setting <code>timestamps.createdAt</code> and <code>timestamps.updatedAt</code>.</p> <p>Basic example:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> travelSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> timestamps<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Travel <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Travel'</span><span class="token punctuation">,</span> thingSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> travel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Travel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> travel<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `createdAt` &amp; `updatedAt` will be included</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Customize <code>createdAt</code> to <code>created_at</code></p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> travelSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> timestamps<span class="token operator">:</span> <span class="token punctuation">{</span> createdAt<span class="token operator">:</span> <span class="token string">'created_at'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Travel <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Travel'</span><span class="token punctuation">,</span> thingSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> travel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Travel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> travel<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// `created_at` &amp; `updatedAt` will be included</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>By default, Ottoman uses <code>new Date()</code> to get the current time. If you want to overwrite the function Ottoman uses to get the current time, you can set the <code>timestamps.currentTime</code> option.
Ottoman will call the <code>timestamps.currentTime</code> function whenever it needs to get the current time.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token function">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  createdAt<span class="token operator">:</span> Number<span class="token punctuation">,</span>
  updatedAt<span class="token operator">:</span> Number<span class="token punctuation">,</span>
  name<span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// Make Ottoman use Unix time (seconds since Jan 1, 1970)</span>
  timestamps<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token function-variable function">currentTime</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="creating-a-model"><a href="#creating-a-model" class="header-anchor">#</a> Creating a Model</h2> <p>To use our schema definition, we need to convert our <code>blogSchema</code> into a <a href="/guides/model.html">Model</a> we can work with. To do so, we pass it into <code>model(modelName, schema)</code>:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Blog <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Blog'</span><span class="token punctuation">,</span> blogSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ready to go!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="instance-methods"><a href="#instance-methods" class="header-anchor">#</a> Instance Methods</h2> <p>Instances of <code>Models</code> are <a href="/guides/document.html">documents</a>. Documents have many of their own <a href="/classes/document.html">built-in instance methods</a>. We may also define our own custom document instance methods.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> connect<span class="token punctuation">,</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">main</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// connecting</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'couchbase://localhost/travel-sample@admin:password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// define a schema</span>
  <span class="token keyword">const</span> animalSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> type<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// assign a function to the &quot;methods&quot; object of our animalSchema</span>
  animalSchema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">findSimilarTypes</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>Now all of our <code>animal</code> instances have a <code>findSimilarTypes</code> method available to them.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Animal <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> animalSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'dog'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> dogs <span class="token operator">=</span> <span class="token keyword">await</span> dog<span class="token punctuation">.</span><span class="token function">findSimilarTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dogs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>Overwriting a default Ottoman document method may lead to unpredictable results.</li> <li>The example above uses the <code>Schema.methods</code> object directly to save an instance method.</li></ul> <div class="custom-block danger"><p class="custom-block-title">Note</p> <p>Do <strong>not</strong> declare <em>methods</em> using ES6 arrow functions (<code>=&gt;</code>). Arrow functions <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener noreferrer">explicitly prevent binding<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>this</code>, so your method will <strong>not</strong> have access to the document, and the above examples will not work.</p></div> <h2 id="statics"><a href="#statics" class="header-anchor">#</a> Statics</h2> <p>You can also add static functions to your model.</p> <p>Add a function property to <code>schema.statics</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Assign a function to the &quot;statics&quot; object of our animalSchema</span>
animalSchema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">findByName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Animal <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Animal'</span><span class="token punctuation">,</span> animalSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> animals <span class="token operator">=</span> <span class="token keyword">await</span> Animal<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span><span class="token string">'fido'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="custom-block danger"><p class="custom-block-title">Note</p> <p>Do <strong>not</strong> declare <em>statics</em> using ES6 arrow functions (<code>=&gt;</code>). Arrow functions <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions" target="_blank" rel="noopener noreferrer">explicitly prevent binding<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>this</code>, so the above examples will <strong>not</strong> work because of the value of <code>this</code>.</p></div> <h2 id="indexes"><a href="#indexes" class="header-anchor">#</a> Indexes</h2> <p>You can specify several indexes on a model. There are different kinds of indexes, each with its own benefits and restrictions.</p> <p>To specify indexes on a <a href="/guides/schema">Schema</a>, use the index key on the schema:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  email<span class="token operator">:</span> String<span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>
    first<span class="token operator">:</span> String<span class="token punctuation">,</span>
    last<span class="token operator">:</span> String<span class="token punctuation">,</span>
    full<span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findByEmail <span class="token operator">=</span> <span class="token punctuation">{</span>
  by<span class="token operator">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'refdoc'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findByFirstName <span class="token operator">=</span> <span class="token punctuation">{</span>
  by<span class="token operator">:</span> <span class="token string">'name.first'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'view'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findByLastName <span class="token operator">=</span> <span class="token punctuation">{</span>
  by<span class="token operator">:</span> <span class="token string">'name.last'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'n1ql'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>To ensure that server is working, you must call the <code>start</code> method. This method will internally generate a list of indexes and scopes, collections (if you have the developer preview active) which will be used with the most optimal configuration for them and will build the structures that might be missing on the server. This method must be called after all models are defined, and it is a good idea to call this only when needed rather than any time your server is started.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> connect<span class="token punctuation">,</span> model<span class="token punctuation">,</span> start<span class="token punctuation">,</span> close <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ottoman'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'couchbase://localhost/travel-sample@admin:password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Jane Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Ottoman is ready!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">User '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> newUser<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' successfully created</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ERROR: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> e<span class="token punctuation">.</span>message <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>You should see results similar to the following:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>Ottoman is ready<span class="token operator">!</span>
User <span class="token string">'Jane Doe'</span> successfully created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="index-types"><a href="#index-types" class="header-anchor">#</a> Index Types</h2> <p>Below are some quick notes on the types of indexes available, and their pros and cons. For a more in-depth discussion, consider reading <a href="https://blog.couchbase.com/determine-data-access-in-couchbase/" target="_blank" rel="noopener noreferrer">Couchbasics: How Functional and Performance Needs Determine Data Access in Couchbase<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="n1ql-query-language"><a href="#n1ql-query-language" class="header-anchor">#</a> N1QL Query Language</h3> <p>These indexes are the default and use the Couchbase Server's SQL-like query language, <a href="https://docs.couchbase.com/server/current/n1ql/query.html" target="_blank" rel="noopener noreferrer">N1QL<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. When <code>start</code> or <code>ensureIndexes</code> functions are executed, Ottoman automatically creates several secondary indexes so that the models can make queries to the database. These indexes are more performant than views in many cases and are significantly more flexible, allowing even un-indexed searches.</p> <p>N1QL indexes in Ottoman use <a href="https://docs.couchbase.com/server/current/learn/services-and-indexes/indexes/global-secondary-indexes.html" target="_blank" rel="noopener noreferrer">Couchbase GSIs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. If you need speed, and the flexibility of queries, this is the way to go.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> String<span class="token punctuation">,</span>
  email<span class="token operator">:</span> String<span class="token punctuation">,</span>
  card<span class="token operator">:</span> <span class="token punctuation">{</span>
    cardNumber<span class="token operator">:</span> String<span class="token punctuation">,</span>
    zipCode<span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// N1QL index declaration</span>
UserSchema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findN1qlByNameandEmail <span class="token operator">=</span> <span class="token punctuation">{</span>
  by<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> select<span class="token operator">:</span> <span class="token string">'name, email'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'n1ql'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Model declaration</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Some data to test</span>
<span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">index</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'index@email.com'</span><span class="token punctuation">,</span>
  card<span class="token operator">:</span> <span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token string">'424242425252'</span><span class="token punctuation">,</span> zipCode<span class="token operator">:</span> <span class="token string">'42424'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Create new user instance</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Save data</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Call findN1qlByNameandEmail index</span>
<span class="token keyword">const</span> usersN1ql <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findN1qlByNameandEmail</span><span class="token punctuation">(</span><span class="token punctuation">[</span>userData<span class="token punctuation">.</span>name<span class="token punctuation">,</span> userData<span class="token punctuation">.</span>email<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>usersN1ql<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>// Output<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string">&quot;_type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;User&quot;</span>,
    <span class="token string">&quot;email&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;index@email.com&quot;</span>,
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;index&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">Not Recommended</p> <p><code>ensureIndex</code> is nice for development, but it's recommended this behavior be disabled in production since index creation can cause a significant performance impact.
Disable the behavior by not executing <code>ensureIndex</code> function. (for example you can use node env variable to know when you are in development mode [process.ENV.development])</p> <p>Notice: the <code>start</code> function should be disabled too, owing to its use of <code>ensureIndexes</code> internally.</p></div> <h3 id="refdoc"><a href="#refdoc" class="header-anchor">#</a> RefDoc</h3> <p>These indexes are the most performant, but the least flexible. They allow only a single document to occupy any particular value and do direct key-value lookups using a referential document to identify a matching document in Couchbase.</p> <p>In short, if you need to look up a document by a single value of a single attribute quickly (e.g. key lookups), this is the way to go. But you cannot combine multiple refdoc indexes to speed up finding something like &quot;all customers with the first name of 'John' and last name of 'Smith'&quot;.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> String<span class="token punctuation">,</span>
  email<span class="token operator">:</span> String<span class="token punctuation">,</span>
  card<span class="token operator">:</span> <span class="token punctuation">{</span>
    cardNumber<span class="token operator">:</span> String<span class="token punctuation">,</span>
    zipCode<span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Refdoc index declaration</span>
UserSchema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findRefName <span class="token operator">=</span> <span class="token punctuation">{</span> by<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">'refdoc'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Model declaration</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Some data to test</span>
<span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">index</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'index@email.com'</span><span class="token punctuation">,</span>
  card<span class="token operator">:</span> <span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token string">'424242425252'</span><span class="token punctuation">,</span> zipCode<span class="token operator">:</span> <span class="token string">'42424'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Create new user instance</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Save data</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Call findRefName index</span>
<span class="token keyword">const</span> userRefdoc <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findRefName</span><span class="token punctuation">(</span>userData<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userRefdoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;index&quot;</span>,
  <span class="token string">&quot;email&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;index@email.com&quot;</span>,
  <span class="token string">&quot;card&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;cardNumber&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;424242425252&quot;</span>,
    <span class="token string">&quot;zipCode&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;42424&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;roles&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;admin&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
  <span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;66c2d0dd-76ab-4b91-83b4-353893e3ede3&quot;</span>,
  <span class="token string">&quot;_type&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;User&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p><strong>Refdoc Index</strong> is not managed by Couchbase but strictly by Ottoman. It does not guarantee consistency if the keys that are a part of these indexes are updated by an external operation, like N1QL for example.</p> <p><strong><em>Needs to be used with caution!!!</em></strong></p></div> <h3 id="view"><a href="#view" class="header-anchor">#</a> View</h3> <div class="custom-block warning"><p class="custom-block-title">Deprecated</p> <p>View indexes were deprecated in Ottoman v2 and will be removed in the next major version of the package.</p></div> <p>This type of index is always available once <code>ensureIndexes</code> is called and will work with any Couchbase Server version.</p> <p>Because views use map-reduce, certain types of queries can be faster as the query can be parallelized over all nodes in the cluster, with each node returning only partial results. One of the cons of views is that they are eventually consistent by default, and incur a performance penalty if you want consistency in the result.</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> String<span class="token punctuation">,</span>
  email<span class="token operator">:</span> String<span class="token punctuation">,</span>
  card<span class="token operator">:</span> <span class="token punctuation">{</span>
    cardNumber<span class="token operator">:</span> String<span class="token punctuation">,</span>
    zipCode<span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// View index declaration</span>
UserSchema<span class="token punctuation">.</span>index<span class="token punctuation">.</span>findByName <span class="token operator">=</span> <span class="token punctuation">{</span> by<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">'view'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Model declaration</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Some data to test</span>
<span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">index</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'index@email.com'</span><span class="token punctuation">,</span>
  card<span class="token operator">:</span> <span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token string">'424242425252'</span><span class="token punctuation">,</span> zipCode<span class="token operator">:</span> <span class="token string">'42424'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  roles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Create new user instance</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Save data</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Call findByName index</span>
<span class="token keyword">const</span> viewIndexOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewIndexOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> usersView <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findByName</span><span class="token punctuation">(</span>userData<span class="token punctuation">.</span>name<span class="token punctuation">,</span> viewIndexOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h2> <p>Hooks are functions that are passed control during the execution of asynchronous functions. Hooks are specified at the schema level and are useful for writing plugins.</p> <h3 id="available-hooks"><a href="#available-hooks" class="header-anchor">#</a> Available Hooks</h3> <ul><li><code>validate</code></li> <li><code>save</code></li> <li><code>update</code></li> <li><code>remove</code></li></ul> <h3 id="register-hooks-with-pre"><a href="#register-hooks-with-pre" class="header-anchor">#</a> Register Hooks with <code>pre</code></h3> <p>Pre functions are executed one after another, for each hook registered.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">document</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do stuff</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>You can use a function that returns a promise. In particular, you can use async/await.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">doMoreStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Or, in Node.js &gt;= 7.6.0:</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">doMoreStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="hooks-use-cases"><a href="#hooks-use-cases" class="header-anchor">#</a> Hooks Use Cases</h3> <p>Hooks are useful for atomizing model logic, such as:</p> <ul><li>Complex validation;</li> <li>Removing dependent documents (removing a user removes all his blogposts);</li> <li>Asynchronous defaults;</li> <li>Asynchronous tasks that a certain action triggers.</li></ul> <h3 id="errors-in-pre-hooks"><a href="#errors-in-pre-hooks" class="header-anchor">#</a> Errors in Pre Hooks</h3> <p>If any pre hook errors out, Ottoman will not execute subsequent hooks or the hooked function.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// You can also return a promise that rejects</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// You can also throw a synchronous error</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// You can also throw an error in an `async` function</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'something went wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later...</span>

<span class="token comment">// Changes will not be persisted to Couchbase Server because a pre hook errored out</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> myDoc<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// something went wrong</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="post-hooks"><a href="#post-hooks" class="header-anchor">#</a> Post Hooks</h3> <p><code>post</code> middleware is executed after the hooked method and all of its pre hooks have been completed.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been validated (but not saved yet)'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been saved'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'remove'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%s has been removed'</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="define-hooks-before-compiling-models"><a href="#define-hooks-before-compiling-models" class="header-anchor">#</a> Define Hooks Before Compiling Models</h3> <p>Calling <code>pre()</code> or <code>post()</code> after compiling a model does not work in Ottoman in general. For example, the below <code>pre('save')</code> hook will not fire.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Compile a model from the schema</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Ottoman will **not** call the middleware function, because</span>
<span class="token comment">// this hook was defined after the model was compiled</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello from pre save'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'test'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="save-validate-hooks"><a href="#save-validate-hooks" class="header-anchor">#</a> Save/Validate Hooks</h3> <p>The <code>save()</code> function triggers <code>validate()</code> hooks, because Ottoman has a built-in <code>pre('save')</code> hook that calls <code>validate()</code>. This means that all <code>pre('validate')</code> and <code>post('validate')</code> hooks get called before any <code>pre('save')</code> hooks. The <code>updateById()</code> function have the same behavior.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed first'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed second'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed third'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this gets printed fourth'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="plugins"><a href="#plugins" class="header-anchor">#</a> Plugins</h2> <p>Schemas are pluggable, that is, they allow for applying pre-packaged capabilities to extend their functionality. This is a very powerful feature.</p> <h3 id="plugin-example"><a href="#plugin-example" class="header-anchor">#</a> Plugin Example</h3> <p>Plugins are a tool for reusing logic in multiple schemas. Suppose you have several models in your database and want to add a function to log all doc before save. Just create a plugin once and apply it to each Schema using the <code>plugin</code> function:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">pluginLog</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">schema</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  isActive<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  name<span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UserSchema<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>pluginLog<span class="token punctuation">)</span>

<span class="token keyword">const</span> UserModel <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Pre save hooks will be executed and it will print the document just before persisting to Couchbase Server</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="global-plugins"><a href="#global-plugins" class="header-anchor">#</a> Global Plugins</h3> <p>Want to register a plugin for all schemas? The Ottoman <code>registerGlobalPlugin</code> function registers a plugin for every schema. For example:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> registerGlobalPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ottoman'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">pluginLog</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">schema</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">doc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">registerGlobalPlugin</span><span class="token punctuation">(</span>pluginLog<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  isActive<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
  name<span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> UserModel <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> UserSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserModel</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Pre save hooks will be executed and it will print the document just before persisting to Couchbase Server</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="strict-mode"><a href="#strict-mode" class="header-anchor">#</a> Strict Mode</h2> <p>The <code>strict</code> option (enabled by default) ensures that values passed to our model constructor that were not specified in our schema do not get saved to the database.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> iAmNotInTheSchema<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// iAmNotInTheSchema is not saved to the db</span>

<span class="token comment">// set to false..</span>
<span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">{</span> iAmNotInTheSchema<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// iAmNotInTheSchema is now saved to the db!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>This value can be overridden at the model instance level by passing as second argument:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// enables strict mode</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// disables strict mode</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="schema-types-immutable-option"><a href="#schema-types-immutable-option" class="header-anchor">#</a> Schema Types Immutable Option</h2> <p>Defines this path as <code>immutable</code>. Ottoman prevents you from changing <code>immutable</code> paths allowing, you to safely write untrusted data to Couchbase without any additional validation.</p> <p>With update functions Ottoman also strips updates to <code>immutable</code> properties from <a href="/interfaces/imodel.html#updatebyid">updateById()</a>, <a href="/interfaces/imodel.html#updatemany">updateMany()</a>, <a href="/interfaces/imodel.html#replacebyid">replaceById()</a> and <a href="/interfaces/imodel.html#findoneandupdate">findOneAndUpdate()</a>. Your update will succeed if you try to overwrite an <code>immutable</code> property, Ottoman will just strip out the <code>immutable</code> property.</p> <p>Let's see this option in action using <code>findOneAndUpdate</code> on <code>immutable</code> properties:</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// Define base data</span>
<span class="token keyword">const</span> cardData <span class="token operator">=</span> <span class="token punctuation">{</span>
  cardNumber<span class="token operator">:</span> <span class="token string">'5678 5678 5678 5678'</span><span class="token punctuation">,</span>
  zipCode<span class="token operator">:</span> <span class="token string">'56789'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cardDataUpdate <span class="token operator">=</span> <span class="token punctuation">{</span>
  cardNumber<span class="token operator">:</span> <span class="token string">'4321 4321 4321 4321'</span><span class="token punctuation">,</span>
  zipCode<span class="token operator">:</span> <span class="token string">'43210'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Define schemas</span>
<span class="token keyword">const</span> CardSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  cardNumber<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> immutable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  zipCode<span class="token operator">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create model</span>
<span class="token keyword">const</span> Card <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Card'</span><span class="token punctuation">,</span> CardSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start Ottoman instance</span>
<span class="token keyword">const</span> ottoman <span class="token operator">=</span> <span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> ottoman<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Initialize data</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>cardData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="immutable-with-strategy-true-default"><a href="#immutable-with-strategy-true-default" class="header-anchor">#</a> Immutable with strategy <code>true</code> <em><strong>(default)</strong></em></h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token punctuation">{</span> $like<span class="token operator">:</span> <span class="token string">'%5678 5678 5678 5678%'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> cardDataUpdate<span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> strict<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Since <code>cardNumber</code> is immutable, Ottoman ignores the update to <code>cardNumber</code> and only <code>zipCode</code> changed:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">{</span>
  cardNumber: <span class="token string">'5678 5678 5678 5678'</span>,
  zipCode: <span class="token string">'43210'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="immutable-with-strategy-false"><a href="#immutable-with-strategy-false" class="header-anchor">#</a> Immutable with strategy <code>false</code></h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token punctuation">{</span> $like<span class="token operator">:</span> <span class="token string">'%5678 5678 5678 5678%'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> cardDataUpdate<span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> strict<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>All properties must change:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">{</span>
  cardNumber: <span class="token string">'4321 4321 4321 4321'</span>,
  zipCode: <span class="token string">'43210'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="immutable-with-strategy-throw"><a href="#immutable-with-strategy-throw" class="header-anchor">#</a> Immutable with strategy <code>THROW</code></h3> <p>If <code>strict</code> is set to <code>THROW</code>, Ottoman will throw an error if you try to update <code>cardNumber</code></p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">findOneAndUpdate</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token punctuation">{</span> $like<span class="token operator">:</span> <span class="token string">'%5678 5678 5678 5678%'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> cardDataUpdate<span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> strict<span class="token operator">:</span> <span class="token constant">CAST_STRATEGY</span><span class="token punctuation">.</span><span class="token constant">THROW</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>will get:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ImmutableError: Field <span class="token string">'cardNumber'</span> is immutable and current cast strategy is <span class="token builtin class-name">set</span> to <span class="token string">'throw'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Ottoman's immutability only applies to <code>document</code> that have already been saved to the database.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// Define schema</span>
<span class="token keyword">const</span> CardSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  cardNumber<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String<span class="token punctuation">,</span> immutable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  zipCode<span class="token operator">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create model</span>
<span class="token keyword">const</span> Card <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Card'</span><span class="token punctuation">,</span> CardSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Create document</span>
<span class="token keyword">const</span> myCard <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Card</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token string">'4321 4321 4321 4321'</span><span class="token punctuation">,</span> zipCode<span class="token operator">:</span> <span class="token string">'43210'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Document is new</span>
<span class="token class-name">myCard</span><span class="token punctuation">.</span>$isNew<span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token comment">// can update the document because $isNew: true</span>
myCard<span class="token punctuation">.</span>cardNumber <span class="token operator">=</span> <span class="token string">'0000 0000 0000 0000'</span><span class="token punctuation">;</span>
myCard<span class="token punctuation">.</span>cardNumber<span class="token punctuation">;</span> <span class="token comment">// '0000 0000 0000 0000'</span>

<span class="token comment">// now let's save myCard</span>
<span class="token keyword">const</span> ottoman <span class="token operator">=</span> <span class="token function">getDefaultInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> ottoman<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> myCardSaved <span class="token operator">=</span> <span class="token keyword">await</span> myCard<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// after save</span>
myCardSaved<span class="token punctuation">.</span>cardNumber <span class="token operator">=</span> <span class="token string">'1111 1111 1111 1111'</span><span class="token punctuation">;</span>
myCardSaved<span class="token punctuation">.</span>cardNumber<span class="token punctuation">;</span> <span class="token comment">// '0000 0000 0000 0000', because `cardNumber` is immutable</span>

<span class="token comment">// Example with create</span>
<span class="token keyword">const</span> myCard2 <span class="token operator">=</span> <span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  cardNumber<span class="token operator">:</span> <span class="token string">'4321 4321 4321 4321'</span><span class="token punctuation">,</span>
  zipCode<span class="token operator">:</span> <span class="token string">'3232'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> myCard3 <span class="token operator">=</span> <span class="token keyword">await</span> Card<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> cardNumber<span class="token operator">:</span> <span class="token string">'4321 4321 4321 4321'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// filters</span>
  <span class="token punctuation">{</span> consistency<span class="token operator">:</span> SearchConsistency<span class="token punctuation">.</span><span class="token constant">LOCAL</span> <span class="token punctuation">}</span> <span class="token comment">// options</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

myCard2<span class="token punctuation">.</span>$isNew<span class="token punctuation">;</span> <span class="token comment">// false</span>
myCard3<span class="token punctuation">.</span>$isNew<span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div></div> <h2 id="schema-helpful-methods"><a href="#schema-helpful-methods" class="header-anchor">#</a> Schema Helpful Methods</h2> <p>Each <code>Schema</code> instance has two helpful methods: <code>cast</code> and <code>validate</code>.</p> <h3 id="cast-method"><a href="#cast-method" class="header-anchor">#</a> Cast Method</h3> <p>The <code>cast</code> method gets a Javascript Object as the first parameter and enforces schema types for each field in the schema definition.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> String<span class="token punctuation">,</span>
  price<span class="token operator">:</span> Number<span class="token punctuation">,</span>
  createdAt<span class="token operator">:</span> Date
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> schema<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'TV'</span><span class="token punctuation">,</span>
  price<span class="token operator">:</span> <span class="token string">'345.99'</span><span class="token punctuation">,</span>
  createdAt<span class="token operator">:</span> <span class="token string">'2020-12-20T16:00:00.000Z'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Result variable now look like this:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">{</span>
  name: <span class="token string">'TV'</span>,
  price: <span class="token number">345.99</span>, // price was casted to Number
  createdAt: <span class="token number">2020</span>-12-20T16:00:00.000Z //createdAt was casted to Date
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="cast-method-options"><a href="#cast-method-options" class="header-anchor">#</a> Cast Method Options</h4> <p><code>cast</code> method have a few useful options:</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">CastOptions</span> <span class="token punctuation">{</span>
  strict<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  skip<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  strategy<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">CAST_STRATEGY</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><code>strict</code> will remove fields not defined in the schema. The default value is set to true.</li> <li><code>skip</code> will be a string array with values of the key you may want to prevent to cast. The default value is empty [].</li> <li><code>strategy</code> when cast action fails, defined strategy is applied. The default strategy is set to <code>defaultOrDrop</code>.</li></ul> <p>Available strategies are:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token constant">CAST_STRATEGY</span>
<span class="token punctuation">{</span>
  <span class="token constant">KEEP</span> <span class="token operator">=</span> <span class="token string">'keep'</span><span class="token punctuation">,</span> <span class="token comment">// will return original value</span>
  drop <span class="token operator">=</span> <span class="token string">'DROP'</span><span class="token punctuation">,</span> <span class="token comment">// will remove the field</span>
  <span class="token constant">THROW</span> <span class="token operator">=</span> <span class="token string">'throw'</span><span class="token punctuation">,</span> <span class="token comment">// will throw an exception</span>
  <span class="token constant">DEFAULT_OR_DROP</span> <span class="token operator">=</span> <span class="token string">'defaultOrDrop'</span><span class="token punctuation">,</span> <span class="token comment">// use default or remove the field if no default was provided</span>
  <span class="token constant">DEFAULT_OR_KEEP</span> <span class="token operator">=</span> <span class="token string">'defaultOrKeep'</span> <span class="token comment">// use default or return original value</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="validate-method"><a href="#validate-method" class="header-anchor">#</a> Validate method</h3> <p>The <code>validate</code> method gets a Javascript Object as the first parameter and enforces schema types, rules, and validations for each field in the schema definition. If something fails an exception will be throw up, else the <code>validate</code> method will return a valid object for the current Schema.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> String<span class="token punctuation">,</span>
  price<span class="token operator">:</span> Number<span class="token punctuation">,</span>
  createdAt<span class="token operator">:</span> Date
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> schema<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'TV'</span><span class="token punctuation">,</span>
  price<span class="token operator">:</span> <span class="token string">'345.99'</span><span class="token punctuation">,</span>
  createdAt<span class="token operator">:</span> <span class="token string">'2020-12-20T16:00:00.000Z'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Result variable now looks like this:</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token punctuation">{</span>
  name: <span class="token string">'TV'</span>,
  price: <span class="token number">345.99</span>, <span class="token comment"># price was casted to Number</span>
  createdAt: <span class="token number">2020</span>-12-20T16:00:00.000Z <span class="token comment"># createdAt was casted to Date</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="validate-method-options"><a href="#validate-method-options" class="header-anchor">#</a> Validate Method Options</h4> <p><code>validate</code> method has 1 option:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  strict<span class="token operator">:</span> boolean<span class="token punctuation">;</span> <span class="token comment">// strict set to true, will remove field not defined in the schema</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>By default, it will get the <code>strict</code> option value set via the Schema constructor.</p> <h2 id="extend-schemas"><a href="#extend-schemas" class="header-anchor">#</a> Extend Schemas</h2> <h3 id="add-method"><a href="#add-method" class="header-anchor">#</a> Add Method</h3> <p>The <code>add</code> method allows adding extra fields or extending properties of other schemas.</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> plane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> boeing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> price<span class="token operator">:</span> Number <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
boeing<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plane<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// You can add also add fields to this schema</span>
boeing<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> Boolean <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>When a schema is added, the following properties are copied: fields, statics, indexes, methods, and hooks. Properties that already exist in the schema (fields, statics, indexes, methods) are overwritten by those of the added schema, except for hooks that are combined.</p></div> <h2 id="next-up"><a href="#next-up" class="header-anchor">#</a> Next Up</h2> <p>Nice, now we'll can see how <a href="/guides/model">Models</a> works.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.2456a84d.js" defer></script><script src="/assets/js/2.bbab3e56.js" defer></script><script src="/assets/js/10.a2b444de.js" defer></script>
  </body>
</html>
