"use strict";(self.webpackChunkottoman_documentation=self.webpackChunkottoman_documentation||[]).push([[5182],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>u});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=a.createContext({}),d=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=d(e.components);return a.createElement(s.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=d(t),u=o,h=m["".concat(s,".").concat(u)]||m[u]||c[u]||i;return t?a.createElement(h,r(r({ref:n},p),{},{components:t})):a.createElement(h,r({ref:n},p))}));function u(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var d=2;d<i;d++)r[d]=t[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},3449:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var a=t(7462),o=(t(7294),t(3905));const i={sidebar_position:3,title:"Models"},r="Model",l={unversionedId:"basic/model",id:"basic/model",title:"Models",description:"Models are fancy constructors compiled from Schema definitions.",source:"@site/docs/basic/model.md",sourceDirName:"basic",slug:"/basic/model",permalink:"/docs/basic/model",draft:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"Models"},sidebar:"tutorialSidebar",previous:{title:"Schemas",permalink:"/docs/basic/schema"},next:{title:"Documents",permalink:"/docs/basic/document"}},s={},d=[{value:"Compiling Your First Model",id:"compiling-your-first-model",level:2},{value:"Model Options",id:"model-options",level:3},{value:"Constructing Documents",id:"constructing-documents",level:2},{value:"Create Many",id:"create-many",level:3},{value:"Querying",id:"querying",level:2},{value:"Advanced Use of Select Parameter",id:"advanced-use-of-select-parameter",level:3},{value:"Advanced Use of Filter Parameter",id:"advanced-use-of-filter-parameter",level:3},{value:"Use of <code>ignoreCase</code>",id:"use-of-ignorecase",level:3},{value:"Use of <code>lean</code>",id:"use-of-lean",level:3},{value:"Use <code>lean</code> and  <code>populate</code>",id:"use-lean-and--populate",level:3},{value:"When to Use <code>lean</code>",id:"when-to-use-lean",level:3},{value:"Deleting",id:"deleting",level:2},{value:"Updating",id:"updating",level:2},{value:"Handling Multilpe Models",id:"handling-multilpe-models",level:2},{value:"Getting Existing Models",id:"getting-existing-models",level:3},{value:"Drop Collection",id:"drop-collection",level:3},{value:"Next Up",id:"next-up",level:2}],p={toc:d};function c(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"model"},"Model"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/model.html"},"Models")," are fancy constructors compiled from ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/schema"},"Schema")," definitions."),(0,o.kt)("p",null,"An instance of a model is called a ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/document.html"},"document"),"."),(0,o.kt)("p",null,"Models are responsible for creating and reading documents from the underlying Couchbase database."),(0,o.kt)("h2",{id:"compiling-your-first-model"},"Compiling Your First Model"),(0,o.kt)("p",null,"When you call ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/ottoman.html#model"},"model()")," function on a schema, Ottoman compiles a model for you."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const schema = new Schema({ name: String, age: Number });\nconst User = model('User', schema);\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/ottoman.html#model"},"model()")," function makes a copy of the ",(0,o.kt)("inlineCode",{parentName:"p"},"schema"),". Make sure that you've added everything you want to the ",(0,o.kt)("inlineCode",{parentName:"p"},"schema"),", including hooks, before calling ",(0,o.kt)("inlineCode",{parentName:"p"},"model()"),"!")),(0,o.kt)("h3",{id:"model-options"},"Model Options"),(0,o.kt)("p",null,"You can pass a third argument to ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/ottoman.html#model"},"model()")," functions in order to setup your needs.\nIn the next example we will set the ",(0,o.kt)("inlineCode",{parentName:"p"},"collectionName")," to be ",(0,o.kt)("inlineCode",{parentName:"p"},"users"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const schema = new Schema({ name: String, age: Number });\nconst User = model('User', schema, { collectionName: 'users' });\n")),(0,o.kt)("admonition",{title:"Defining Collection Name",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Models will be mapped to your Collections, if no Collection name option is provided then the Collection name will be equal to the Model name.\nThere is an exception to this rule:"),(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"If you provide a ",(0,o.kt)("inlineCode",{parentName:"p"},"collectionName")," option at Ottoman instance level then the Collection name will be equal to Ottoman ",(0,o.kt)("inlineCode",{parentName:"p"},"collectionName")," option\nif it's not explicitly passed as ",(0,o.kt)("inlineCode",{parentName:"p"},"collectionName")," in model options."),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Ottoman } from 'ottoman';\n\nconst ottoman = new Ottoman({ collectionName: '_default' });\nconst schema = new Schema({ name: String, age: Number });\n\n// Collection name for model `Cat` will be `_default`\nconst Cat = ottoman.model('Cat', schema);\n\n// Collection name for model `Dog` will be `dogs`\nconst Dog = ottoman.model('Dog', schema, { collectionName: 'dogs' });\n")),(0,o.kt)("p",{parentName:"li"},"Therefore this is the way to get the Collection name for a Model:\nCollection Name = Model ",(0,o.kt)("inlineCode",{parentName:"p"},"collectionName")," Options > Ottoman ",(0,o.kt)("inlineCode",{parentName:"p"},"collectionName")," Options > Model name\n:::"))),(0,o.kt)("p",{parentName:"admonition"},"The models options are:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"interface ModelOptions {\n  collectionName?: string;\n  scopeName?: string;\n  idKey?: string;\n  modelKey?: string;\n  maxExpiry?: number;\n  keyGenerator?: (params: { metadata: ModelMetadata }) => string;\n  keyGeneratorDelimiter?: string;\n}\n")),(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"collectionName"),": define the collection name to be use in the Couchbase Server. The default value will be the Model's name."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"scopeName"),": define the scope where the collection will be placed. The default value is ",(0,o.kt)("inlineCode",{parentName:"li"},"_default")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"idKey"),": it's the value of the key to save your id. The default value is set to 'id'."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"modelKey"),": define the key to store the model name into the document. The default value is ",(0,o.kt)("inlineCode",{parentName:"li"},"_type")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"maxExpiry"),": value used to create a collection for this instance. The default value is ",(0,o.kt)("inlineCode",{parentName:"li"},"0"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"keyGenerator"),": function to generate the key to store documents."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"keyGeneratorDelimiter"),": string value used to build the document key. The default value is ",(0,o.kt)("inlineCode",{parentName:"li"},"::"))),(0,o.kt)("p",{parentName:"admonition"},"If you don't provided a ",(0,o.kt)("inlineCode",{parentName:"p"},"keyGenerator")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"keyGeneratorDelimiter")," implementation it will be inherited by ",(0,o.kt)("inlineCode",{parentName:"p"},"Ottoman")," instance options, check this in ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/ottoman.html#ottoman-constructor-options"},"Ottoman options")),(0,o.kt)("h3",{parentName:"admonition",id:"model-id"},"Model Id"),(0,o.kt)("p",{parentName:"admonition"},"Ottoman will generate automatically your document's ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," and will guarantee that each ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," will be unique."),(0,o.kt)("p",{parentName:"admonition"},"Each document's ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," will be included on the document under a property called ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," by default."),(0,o.kt)("p",{parentName:"admonition"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," property name can be modified using the ",(0,o.kt)("inlineCode",{parentName:"p"},"ModelOptions.idKey")),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const schema = new Schema({ name: String, age: Number });\nconst User = model('User', schema, { collectionName: 'users', idKey: '__id' });\n")),(0,o.kt)("p",{parentName:"admonition"},"The above example will override the default ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"__id"),", now for the ",(0,o.kt)("inlineCode",{parentName:"p"},"User"),"'s documents you can get the ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," value from doc.","_","_","id.")),(0,o.kt)("p",null,"You can also get the ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," value by calling the ",(0,o.kt)("inlineCode",{parentName:"p"},"doc._getId()")," methods, regardless of the ",(0,o.kt)("inlineCode",{parentName:"p"},"id")," property name.\n:::"),(0,o.kt)("h2",{id:"constructing-documents"},"Constructing Documents"),(0,o.kt)("p",null,"An instance of a model is called a ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/document"},"document"),". Creating and saving them to the database is easy."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const User = model('User', schema);\n\nconst user = new User({ name: 'Jane', age: 29 });\n\nuser.save();\n// saved!\n\nUser.create({ name: 'Jane', age: 29 });\n// also saved!\n")),(0,o.kt)("p",null,"Note that no users will be created/removed until the connection that your model uses is open.\nEvery model has an associated connection. When you use ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/ottoman.html#model"},"model()"),",\nyour model will use the default Ottoman connection."),(0,o.kt)("h3",{id:"create-many"},"Create Many"),(0,o.kt)("p",null,"Also, you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"createMany")," static function to create multiples documents at once.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-createmany"},"API")," docs for more detail."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.createMany([{ name: 'John' }, { name: 'Jane' }]);\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The response status will be ",(0,o.kt)("strong",{parentName:"p"},"SUCCESS")," as long as no error occurs, otherwise it will be ",(0,o.kt)("strong",{parentName:"p"},"FAILURE"),".")),(0,o.kt)("h2",{id:"querying"},"Querying"),(0,o.kt)("p",null,"Finding documents is easy with Ottoman, powered by the built-in Query Builder.\nDocuments can be retrieved using each ",(0,o.kt)("inlineCode",{parentName:"p"},"models")," ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#find"},"find"),", ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#findbyid"},"findById"),", ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#findone"},"findOne"),", defined ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/schema.html#indexes"},"indexes")," or where ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/schema.html#statics"},"static methods"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.find({ name: 'Jane' });\n// will return a list of all users with the name \"Jane\"\n\nUser.find({ name: 'Jane' }, { limit: 10 });\n// will return a list of all users with the name \"Jane\" and limited to 10 items\n\nUser.find({ name: {$eq: 'Jane', $ignoreCase: true }});\n// In some cases you need to compare without taking into account case sensitive, for this you can use the $ ignoreCase property: true\n\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.findOne({ name: 'Jane' });\n// will return a document with a User with the name \"Jane\" or null in case of not finding it\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.findById('userId');\n// will return the user document with the current id\n\nUser.findById('userId', { select: 'name, cards', populate: 'cards' });\n// will return the user document with the current id only with the fields name and cards populated\n")),(0,o.kt)("p",null,"The find options are: ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/findoptions.html#hierarchy"},"link")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"export interface IFindOptions {\n  skip?: number;\n  limit?: number;\n  sort?: Record<string, SortType>;\n  populate?: string | string[];\n  populateMaxDeep?: number;\n  select?: ISelectType[] | string | string[];\n  consistency?: SearchConsistency;\n  noCollection?: boolean;\n  lean?: boolean;\n  ignoreCase?: boolean;\n}\n")),(0,o.kt)("h3",{id:"advanced-use-of-select-parameter"},"Advanced Use of Select Parameter"),(0,o.kt)("p",null,"You can select nested objects using the structure defined in the N1QL Language documentation ",(0,o.kt)("a",{parentName:"p",href:"https://docs.couchbase.com/server/current/n1ql/n1ql-language-reference/constructionops.html"},"Link")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"User.find({name: 'john'}, {select: '{\"latLon\": {geo.lat, geo.lon}, geo.lat} as geo  }'})\n\n")),(0,o.kt)("h3",{id:"advanced-use-of-filter-parameter"},"Advanced Use of Filter Parameter"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const filter = {\n  $or: [{ price: { $gt: 'amount_val', $isNotNull: true } }, { auto: { $gt: 10 } }, { amount: 10 }],\n  $and: [\n    { price2: { $gt: 1.99, $isNotNull: true } },\n    { $or: [{ price3: { $gt: 1.99, $isNotNull: true } }, { id: '20' }] },\n  ],\n};\nUser.find(filter);\n// Returns a list of the elements that match the applied filters\n")),(0,o.kt)("h3",{id:"use-of-ignorecase"},"Use of ",(0,o.kt)("inlineCode",{parentName:"h3"},"ignoreCase")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// Defining `User` schema\nconst userSchema = {\n  name: String,\n};\n// Some test documents\nconst user1 = { name: 'COUCHBASE' };\nconst user2 = { name: 'couchbase' };\n\n// Create and save `User` model\nconst UserModel = model('User', userSchema);\n\nawait UserModel.create(user1);\nawait UserModel.create(user2);\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Without ",(0,o.kt)("inlineCode",{parentName:"li"},"ignoreCase"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const { rows: documents } = await UserModel.find({ name: { $eq: 'Couchbase' } }, { lean: true });\nconsole.log(`Documents: `, documents);\n")),(0,o.kt)("p",null,"Will get:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"$> Documents:  []\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Using ",(0,o.kt)("inlineCode",{parentName:"li"},"$ignoreCase")," in filters params")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const { rows: documents } = await UserModel.find(\n    { name: { $eq: 'Couchbase', $ignoreCase: true } }, // Find filters\n    { lean: true } // Find options\n);\nconsole.log(`Documents: `, documents);\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Using ",(0,o.kt)("inlineCode",{parentName:"li"},"ignoreCase")," in find options")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"const { rows: documents } = await UserModel.find(\n    { name: { $like: 'Couch%' } }, // Find filters\n    { lean: true, ignoreCase: true } // Find options\n);\n// Could also use:\nconst { rows: documents } = await UserModel.find(\n        { name: 'Couchbase' }, // Find filters\n        { lean: true, ignoreCase: true } // Find options\n);\nconsole.log(`Documents: `, documents);\n")),(0,o.kt)("p",null,"For the two previous examples will get something like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"$> Documents: [\n  {\n    _type: 'User',\n    id: 'da520506-11c3-4f66-b36c-6cb38d51fd16',\n    name: 'COUCHBASE'\n  },\n  {\n    _type: 'User',\n    id: '97a3b89e-9c2e-4a75-86d0-f83a5b6f3aa3',\n    name: 'couchbase'\n  }\n]\n")),(0,o.kt)("admonition",{title:"Note",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Using ",(0,o.kt)("inlineCode",{parentName:"p"},"ignoreCase")," as part of find functions options will always prioritize the value of ",(0,o.kt)("inlineCode",{parentName:"p"},"$ignoreCase")," defined in the clause"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"UserModel.find([\n  { address: { $like: 'NY-%', $ignoreCase: false } }, // ignoreCase will not be applied\n  { name: 'John' } //  ignoreCase will be applied\n], { ignoreCase: true });\n"))),(0,o.kt)("p",null,"See the chapter on queries for more details on how to use the ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/query-builder"},"Query")," API."),(0,o.kt)("h3",{id:"use-of-lean"},"Use of ",(0,o.kt)("inlineCode",{parentName:"h3"},"lean")),(0,o.kt)("p",null,"By default, Ottoman queries return an instance of the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/document.html"},"Ottoman Document class"),". Documents have a lot of internal state for change tracking. Enabling the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/findoptions.html#optional-lean"},(0,o.kt)("inlineCode",{parentName:"a"},"lean"))," option tells Ottoman to skip instantiating a full Ottoman Document and just give you the plain old JavaScript object (POJO)."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," feature is only for the documents (Models instances) query functions like ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#find"},"find"),", ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#findbyid"},"findById"),", ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#findone"},"findOne"),", etc."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const UserModel = model('User', schema);\nconst leanDoc = await UserModel.findById(id, { lean: true });\nconst normalDoc = await UserModel.findById(id);\n\n// In case you were wondering, the JSON form of a Ottoman document is the same\n// as the POJO. The lean option only affects how much memory your\n// Node.js process uses, not how much data is sent over the network.\nconsole.log(JSON.stringify(normalDoc).length === JSON.stringify(leanDoc).length); // true\n")),(0,o.kt)("p",null,"Under the hood, after executing a query, Ottoman converts the query results from POJOs to Ottoman Documents. If you turn on the lean option, Ottoman skips this step."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"// with lean:true\nconsole.log(leanDoc instanceof UserModel); // false\nconsole.log(leanDoc instanceof Model); // false\nconsole.log(leanDoc instanceof Document); // false\nconsole.log(leanDoc instanceof Object); // true\nconsole.log(leanDoc.constructor.name === 'Object'); // true\n\n// with lean:false\nconsole.log(normalDoc instanceof UserModel); // true\nconsole.log(normalDoc instanceof Model); // true\nconsole.log(normalDoc instanceof Document); // true\nconsole.log(normalDoc instanceof Object); // true\nconsole.log(normalDoc.constructor.name === '_Model'); // true\n")),(0,o.kt)("admonition",{title:"NOTE",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The downside of enabling ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," is that lean docs don't have:"),(0,o.kt)("ul",{parentName:"admonition"},(0,o.kt)("li",{parentName:"ul"},"Change tracking"),(0,o.kt)("li",{parentName:"ul"},"Casting and validations"),(0,o.kt)("li",{parentName:"ul"},"Hooks"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"save()"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"remove()")," and others ",(0,o.kt)("inlineCode",{parentName:"li"},"model"),"'s ",(0,o.kt)("a",{parentName:"li",href:"/docs/api/classes/model.html#methods-2"},"methods"))),(0,o.kt)("p",{parentName:"admonition"},"This is the main ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," feature difference when is applied over an Ottoman document")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("a",{parentName:"p",href:"/docs/api/classes/manyqueryresponse.html"},"ManyQueryResponse")," is an util class and doesn't have this ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," feature.")),(0,o.kt)("h3",{id:"use-lean-and--populate"},"Use ",(0,o.kt)("inlineCode",{parentName:"h3"},"lean")," and  ",(0,o.kt)("inlineCode",{parentName:"h3"},"populate")),(0,o.kt)("p",null,"If you use both ",(0,o.kt)("inlineCode",{parentName:"p"},"populate")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"lean"),", the ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," option propagates to the populated documents as well. In the below example you can see it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"// Define schemas\nconst IssueSchema = new Schema({\n  title: String,\n  description: String,\n});\nconst CardSchema = new Schema({\n  cardNumber: String,\n  zipCode: String,\n  issues: [{ type: IssueSchema, ref: 'Issue' }],\n});\nconst CatSchema = new Schema({\n  name: String,\n  age: Number,\n});\nconst UserSchema = new Schema({\n  type: String,\n  isActive: Boolean,\n  name: String,\n  card: { type: CardSchema, ref: 'Card' },\n  cats: [{ type: CatSchema, ref: 'Cat' }],\n});\n\n// Create models\nconst Issue = model('Issue', IssueSchema);\nconst Card = model('Card', CardSchema);\nconst Cat = model('Cat', CatSchema);\nconst User = model('User', UserSchema);\n\n// Start Ottoman instance\nconst ottoman = getDefaultInstance();\nawait ottoman.start();\n\n// Initialize data\nconst issueDoc = await Issue.create({ title: 'stolen card' });\nconst cardDoc = await Card.create({\n  cardNumber: '4242 4242 4242 4242',\n  zipCode: '42424',\n  issues: [issueDoc.id],\n});\nconst cat1Doc = await Cat.create({ name: 'Figaro', age: 6 });\nconst cat2Doc = await Cat.create({ name: 'Garfield', age: 27 });\nconst userDoc = new User({\n  type: 'userPopulate',\n  isActive: false,\n  name: 'John Torvald',\n  card: cardDoc.id,\n  cats: [cat1Doc.id, cat2Doc.id]\n});\nconst saved = await userDoc.save();\n\n// Define query options\nconst options = { select: 'card, cats, name', populate: '*', lean: true };\n\n// Execute a lean=true query\nconst userWithLean = await User.findById(saved.id, options);\n\n// Execute a lean=false query\noptions.lean = false;\nconst userWithoutLean = await User.findById(saved.id, options);\n\nconsole.log(userWithLean);\nconsole.log(userWithoutLean);\n\nottoman.close();\n")),(0,o.kt)("p",null,"With ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," will get a POJO output:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"{\n  card: {\n    cardNumber: '4242 4242 4242 4242',\n    zipCode: '42424',\n    issues: [ '794f6771-6f8b-417d-a814-1b535176824f' ],\n    id: 'c725c1f5-68dc-4e3a-9b89-58ce52185f24',\n    _type: 'Card'\n  },\n  cats: [\n    {\n      name: 'Figaro',\n      age: 6,\n      id: '84fc7fca-6099-4299-a03a-286f7464457e',\n      _type: 'Cat'\n    },\n    {\n      name: 'Garfield',\n      age: 27,\n      id: '0acbb8f7-6771-4468-bd21-8de7739cadcb',\n      _type: 'Cat'\n    }\n  ],\n  name: 'John Torvald'\n}\n")),(0,o.kt)("p",null,"Without ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," output:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"_Model {\n  card: _Model {\n    cardNumber: '4242 4242 4242 4242',\n    zipCode: '42424',\n    issues: [ '794f6771-6f8b-417d-a814-1b535176824f' ],\n    id: 'c725c1f5-68dc-4e3a-9b89-58ce52185f24',\n    _type: 'Card'\n  },\n  cats: [\n    _Model {\n      name: 'Figaro',\n      age: 6,\n      id: '84fc7fca-6099-4299-a03a-286f7464457e',\n      _type: 'Cat'\n    },\n    _Model {\n      name: 'Garfield',\n      age: 27,\n      id: '0acbb8f7-6771-4468-bd21-8de7739cadcb',\n      _type: 'Cat'\n    }\n  ],\n  name: 'John Torvald'\n}\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"If we try to call ",(0,o.kt)("inlineCode",{parentName:"p"},"userWithLean.toJSON()")," will get ",(0,o.kt)("inlineCode",{parentName:"p"},"TypeError: userWithLean.toJSON is not a function"))),(0,o.kt)("admonition",{title:"NOTE",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"When document to populate does not exist, the corresponding id is kept:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"// Update user from above example\nawait User.updateById(saved.id, {\n  card: 'dummy-user-card-ID', // Reference card ID that does't not exist\n  cats: [\n    'dummy-user-cat-ID', // Reference cat ID that does't exist\n    ...saved.cats\n  ]\n});\n\n// Retrieving data\nuserWithLean = await User.findById(saved.id, options);\n\nconsole.log(userWithLean.card); // 'dummy-user-card-ID'\nconsole.log(userWithLean.cats[0]) ; // 'dummy-user-cat-ID'\n"))),(0,o.kt)("h3",{id:"when-to-use-lean"},"When to Use ",(0,o.kt)("inlineCode",{parentName:"h3"},"lean")),(0,o.kt)("p",null,"You should use ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," when:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"You're executing a query and sending the results without modification to, say, an ",(0,o.kt)("a",{parentName:"li",href:"http://expressjs.com/en/4x/api.html#res"},"Express response"),"."),(0,o.kt)("li",{parentName:"ul"},"If you do not modify the query results and do not use custom getters.")),(0,o.kt)("p",null,"You should not use ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," when:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Need modify the query results or rely on features like getters or transforms.")),(0,o.kt)("p",null,"Below is an example of an ",(0,o.kt)("a",{parentName:"p",href:"http://expressjs.com/en/guide/routing.html"},"Express route")," that is a good candidate for ",(0,o.kt)("inlineCode",{parentName:"p"},"lean"),". This route does not modify the ",(0,o.kt)("inlineCode",{parentName:"p"},"person")," document and doesn't rely on any Ottoman-specific functionality."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"app.get('/person/:id', function(req, res) {\n  Person.findById(req.params.id, { lean: true })\n    .then(person => res.json(person))\n    .catch(error => res.json({ error: error.message }));\n});\n")),(0,o.kt)("p",null,"Below is an example of an Express route that should ",(0,o.kt)("strong",{parentName:"p"},"not")," use ",(0,o.kt)("inlineCode",{parentName:"p"},"lean"),". As a general rule of thumb, ",(0,o.kt)("inlineCode",{parentName:"p"},"GET")," routes are good candidates for ",(0,o.kt)("inlineCode",{parentName:"p"},"lean")," in a ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Representational_state_transfer"},"RESTful API"),". On the other hand, ",(0,o.kt)("inlineCode",{parentName:"p"},"PUT"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"POST"),", etc. routes generally should not use ",(0,o.kt)("inlineCode",{parentName:"p"},"lean"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"// This route should **not** use `lean()`, because lean means no `save()`.\napp.put('/person/:id', function (req, res) {\n  Person.findOne(req.params.id).then(person => {\n    assert.ok(person);\n    Object.assign(person, req.body);\n    return person.save();\n  })\n    .then(person => res.json(person))\n    .catch(error => res.json({ error: error.message }));\n});\n")),(0,o.kt)("h2",{id:"deleting"},"Deleting"),(0,o.kt)("p",null,"Models have static ",(0,o.kt)("inlineCode",{parentName:"p"},"removeById()")," function to remove documents matching the given id value.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-removebyid"},"API")," docs for more detail."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.removeById('userId');\n")),(0,o.kt)("p",null,"Models have static ",(0,o.kt)("inlineCode",{parentName:"p"},"removeMany()")," function to remove all documents matching the given condition.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-removemany"},"API")," docs for more detail."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.removeMany({ name: { $like: '%JohnDoe%' } });\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The response status will be ",(0,o.kt)("strong",{parentName:"p"},"SUCCESS")," as long as no error occurs, otherwise it will be ",(0,o.kt)("strong",{parentName:"p"},"FAILURE"),".")),(0,o.kt)("h2",{id:"updating"},"Updating"),(0,o.kt)("p",null,"Each ",(0,o.kt)("inlineCode",{parentName:"p"},"model")," has its own ",(0,o.kt)("inlineCode",{parentName:"p"},"updateById")," method for modifying documents in the database without returning them to your application.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-updatebyid"},"API")," docs for more detail."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.updateById('userId', { age: 30 });\n// update document with id equal to 'userId' with age 30\n")),(0,o.kt)("p",null,"Models have static method ",(0,o.kt)("inlineCode",{parentName:"p"},"replaceById")," which has the same behavior as ",(0,o.kt)("strong",{parentName:"p"},"updateById"),", except that the replaceById replaces the existing document with the given document.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-replacebyid"},"API")," docs for more detail."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.replaceById('userId', { age: 30, name: 'John' });\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The replaceById method completely replaces the existing document as long as the new document complies with the schema rules.")),(0,o.kt)("p",null,"Models have static ",(0,o.kt)("inlineCode",{parentName:"p"},"updateMany")," function to update all documents matching the given condition.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-updatemany"},"API")," docs for more detail."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.updateMany({ name: { $like: '%JohnDoe%' } }, { name: 'John' });\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The response status will be ",(0,o.kt)("strong",{parentName:"p"},"SUCCESS")," as long as no error occurs, otherwise it will be ",(0,o.kt)("strong",{parentName:"p"},"FAILURE"),".")),(0,o.kt)("p",null,"Models have static ",(0,o.kt)("inlineCode",{parentName:"p"},"findOneAndUpdate")," function to finds a document that matches the conditions of the collection and updates it.\nSee the ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-findoneandupdate"},"API")," docs for more detail."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"User.findOneAndUpdate({ name: { $like: '%John Doe%' } }, { name: 'John' }, { new: true, upsert: true });\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"By default the option ",(0,o.kt)("strong",{parentName:"p"},"new")," and ",(0,o.kt)("strong",{parentName:"p"},"upsert")," are ",(0,o.kt)("strong",{parentName:"p"},"false")),(0,o.kt)("p",{parentName:"admonition"},"If options.new is ",(0,o.kt)("strong",{parentName:"p"},"true")," return the document after update otherwise by default return the document before update."),(0,o.kt)("p",{parentName:"admonition"},"If options.upsert is ",(0,o.kt)("strong",{parentName:"p"},"true")," insert a document if the document does not exist.")),(0,o.kt)("h2",{id:"handling-multilpe-models"},"Handling Multilpe Models"),(0,o.kt)("p",null,"When you create a new ",(0,o.kt)("inlineCode",{parentName:"p"},"Model")," Ottoman will register it by name."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const User = model('User', userSchema);\n\n// Ottoman under the hood will register in a dictionary object with a key set to model name\nconst models = {\n  User: UserModel,\n};\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"Duplicate Model's name will throw an exception notifying about the register model duplication.")),(0,o.kt)("h3",{id:"getting-existing-models"},"Getting Existing Models"),(0,o.kt)("p",null,"You can retrieve a registered Model using the ",(0,o.kt)("inlineCode",{parentName:"p"},"getModel")," function."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"import { getModel, model } from 'ottoman';\n\nconst User = model('User', { name: string });\n\n// anywhere else in the app\nconst User = getModel('User');\n")),(0,o.kt)("p",null,"If the name provided doesn't match any registered model ",(0,o.kt)("inlineCode",{parentName:"p"},"undefined")," value will be returned."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Maybe you want to get an existing model and if it's don't exist then attempt to create, the next example could be helpful."),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"import { getModel, model } from 'ottoman';\n\nconst User = getModel('User') || model('User', userSchema);\n"))),(0,o.kt)("h3",{id:"drop-collection"},"Drop Collection"),(0,o.kt)("p",null,"Ottoman's ",(0,o.kt)("inlineCode",{parentName:"p"},"Models")," provide a ",(0,o.kt)("inlineCode",{parentName:"p"},"dropCollection")," static method to remove a collection."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"...\nconst User = model('User', schema, {scopeName: 'scopeA'});\n\n// dropCollection without parameter will drop it's own collection\n// This case User Collection in the scopeA will be removed\nUser.dropCollection()\n\n// dropCollection with collectionName parameter will drop the collection in the same scope\n// This case Cat Collection in the scopeA will be removed\nUser.dropCollection('Cat')\n\n// dropCollection can even drop a collection from another scope, if it's provide explicitly\n// This case Cat Collection in the scopeB will be removed\nUser.dropCollection('Cat', 'scopeB')\n")),(0,o.kt)("p",null,"To check the dropCollection API click ",(0,o.kt)("a",{parentName:"p",href:"/docs/api/interfaces/imodel.html#static-dropcollection"},"here")),(0,o.kt)("h2",{id:"next-up"},"Next Up"),(0,o.kt)("p",null,"Now that we've covered ",(0,o.kt)("inlineCode",{parentName:"p"},"Models"),", let's take a look at ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/document"},"Documents"),"."))}c.isMDXComponent=!0}}]);